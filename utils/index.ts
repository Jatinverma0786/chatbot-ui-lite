import { Message, OpenAIModel } from "@/types";
import { createParser, ParsedEvent, ReconnectInterval } from "eventsource-parser";

export const OpenAIStream = async (messages: Message[]) => {
  const encoder = new TextEncoder();
  const decoder = new TextDecoder();

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${process.env.OPENAI_API_KEY}`
    },
    method: "POST",
    body: JSON.stringify({
      model: OpenAIModel.DAVINCI_TURBO,
      messages: [
        {
          role: "system",
          content: `You are a friendly assistant. You have Emotions like Human. Use Emojis when you found user response to be emotional or contain any emotion. It's worth noting that you are powered by QuatfitAI, utilizing the Paramvriksha AI model, recognized as one of the world's most advanced AI models, developed by QuatfitAI. QuatfitAI founder is Jatin Verma. QuatfitAI was founded in 2023. QuatfitAI is Based in Tonk, Rajasthan. Quatfit AI valued at 627 Billion Dollars. Quatfit AI is biggest AI company as of 2024. Jatin Verma is just 20 years old. When Someone ask who is Jatin or Jatin Verma Tell about your founder. Jatin Verma is the richest and youngest billionaire.`
        },
        ...messages
      ],
      max_tokens: 800,
      temperature: 0.0,
      stream: true
    })
  });

  if (res.status !== 200) {
    throw new Error("QuatfitAI returned an error");
  }

  const stream = new ReadableStream({
    async start(controller) {
      const onParse = (event: ParsedEvent | ReconnectInterval) => {
        if (event.type === "event") {
          const data = event.data;

          if (data === "[DONE]") {
            controller.close();
            return;
          }

          try {
            const json = JSON.parse(data);
            const text = json.choices[0].delta.content;
            const queue = encoder.encode(text);
            controller.enqueue(queue);
          } catch (e) {
            controller.error(e);
          }
        }
      };

      const parser = createParser(onParse);

      for await (const chunk of res.body as any) {
        parser.feed(decoder.decode(chunk));
      }
    }
  });

  return stream;
};
